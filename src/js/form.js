const FORM_CONFIG={phonePattern:/^[0-9]{10,15}$/,defaultDeliveryCost:300,businessLocation:{address:"Av. Roque S√°enz Pe√±a, C√≥rdoba Capital, C√≥rdoba",lat:-31.307277,lng:-64.463337,zoom:16}};function getCarritoActual(){if("undefined"!=typeof selectedItems&&Array.isArray(selectedItems))return selectedItems;if(window.selectedItems&&Array.isArray(window.selectedItems))return window.selectedItems;try{const e=localStorage.getItem("deliciasExpress_selectedItems");if(e)return JSON.parse(e)}catch(e){}return[]}function generarUbicacionGoogleMaps(){try{const e=document.getElementById("customer-street")?.value.trim()||"",t=document.getElementById("customer-number")?.value.trim()||"",n=document.getElementById("customer-city")?.value.trim()||"";if(!e||!t||!n)return null;const o=`${e} ${t}, ${n}, C√≥rdoba, Argentina`,a=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o)}`;return{texto:`üìç *UBICACI√ìN EN GOOGLE MAPS:*\n${a}`,url:a}}catch(e){return console.error(e),null}}function setupMap(){"function"==typeof window.setupStaticMap?window.setupStaticMap():setupMapFallback()}function setupMapFallback(){const e=document.getElementById("map-frame");if(!e)return;const t=FORM_CONFIG.businessLocation.lat,n=FORM_CONFIG.businessLocation.lng,o=`https://www.openstreetmap.org/export/embed.html?bbox=${n-.003},${t-.003},${n+.003},${t+.003}&layer=mapnik&marker=${t},${n}`;e.innerHTML=`\n        <iframe \n            src="${o}"\n            width="100%" \n            height="100%" \n            style="border:none;"\n            allowfullscreen\n            loading="lazy"\n            title="Ubicaci√≥n del Negocio">\n        </iframe>\n    `}function calculateSubtotal(){const e=getCarritoActual();if(!e||0===e.length)return 0;return e.reduce(((e,t)=>e+((t.price||0)*(t.quantity||1)+(t.sauces?t.sauces.reduce(((e,t)=>e+t.price),0):0)+(t.generalExtras?t.generalExtras.reduce(((e,t)=>e+t.price*t.quantity),0):0))),0)}function calculateGlobalExtras(){let e=0;return document.querySelectorAll('input[type="checkbox"]:not(.cart-item-check)').forEach((t=>{t.checked&&(t.dataset.price?e+=parseInt(t.dataset.price)||0:(t.id.includes("cubiertos")&&(e+=50),t.id.includes("salsas")&&(e+=100),t.id.includes("servilletas")&&(e+=30)))})),e}function updateOrderSummary(){const e=calculateSubtotal()+calculateGlobalExtras(),t=document.getElementById("subtotal"),n=document.getElementById("total-cost"),o=document.getElementById("delivery-cost");t&&(t.textContent=`$${e}`);const a=document.getElementById("customer-street")?.value.trim(),r=document.getElementById("customer-number")?.value.trim(),s=document.getElementById("customer-city")?.value.trim();if(!(a&&r&&s))return o&&(o.textContent="A calcular",o.className="delivery-cost-warning",o.dataset.cost="0"),void(n&&(n.innerHTML=`$${e} <span style="font-size: 0.7em; color: #dc3545;">+ Env√≠o</span>`));let c=0,l=!1,d=!1;if(o)if("true"===o.dataset.calculating)d=!0;else if(o.dataset.cost)c=parseInt(o.dataset.cost)||0,o.textContent.includes("A calcular")||(l=!0);else{const e=o.textContent;e.includes("$")&&/\d/.test(e)&&(c=parseInt(e.replace(/[^0-9]/g,""))||0,l=!0)}if(n)if(d)n.innerHTML=`$${e} <span style="font-size: 0.7em; color: #666;">+ Calculando...</span>`;else if(l){const t=e+c;n.textContent=`$${t}`,n.style.color="#000"}else n.innerHTML=`$${e} <span style="font-size: 0.7em; color: #dc3545;">+ Env√≠o</span>`,o&&!d&&(o.textContent="A calcular",o.className="delivery-cost-warning")}function validateForm(){if(0===getCarritoActual().length)return showCustomAlert("‚ùå El carrito est√° vac√≠o","Agrega productos antes de continuar."),!1;const e=[{id:"customer-name",nombre:"nombre"},{id:"customer-phone",nombre:"WhatsApp"},{id:"customer-street",nombre:"calle"},{id:"customer-number",nombre:"n√∫mero"},{id:"customer-neighborhood",nombre:"barrio"},{id:"customer-city",nombre:"ciudad"}];let t=!0,n=null;for(let o of e){const e=document.getElementById(o.id);if(e){e.value.trim()?e.style.borderColor="":(n||(n=e),t=!1,e.style.borderColor="#dc3545")}}return!(!t&&n)||(n.focus(),showCustomAlert("‚ùå Campos incompletos","Por favor completa todos los campos requeridos."),!1)}function createOrderModal(){if(document.getElementById("order-confirm-modal"))return;document.body.insertAdjacentHTML("beforeend",'\n        <div id="order-confirm-modal" class="modal-overlay">\n            <div class="modal-content">\n                <div class="modal-icon">üìã</div>\n                <h3>Confirmar Pedido</h3>\n                <div id="order-modal-details" style="text-align: left; margin: 15px 0; font-size: 0.9rem; color: #555; background: #f9f9f9; padding: 15px; border-radius: 8px;">\n                    </div>\n                <div class="modal-actions">\n                    <button id="btn-cancel-order" class="modal-btn cancel">Cancelar</button>\n                    <button id="btn-confirm-order" class="modal-btn confirm">Enviar a WhatsApp</button>\n                </div>\n            </div>\n        </div>\n    ')}function createAlertModal(){if(document.getElementById("custom-alert-modal"))return;document.body.insertAdjacentHTML("beforeend",'\n        <div id="custom-alert-modal" class="modal-overlay">\n            <div class="modal-content">\n                <div class="modal-icon warning" id="alert-icon">‚ö†Ô∏è</div>\n                <h3 id="alert-title">Atenci√≥n</h3>\n                <p id="alert-message"></p>\n                <div class="modal-actions">\n                    <button id="btn-close-alert" class="modal-btn confirm">Entendido</button>\n                </div>\n            </div>\n        </div>\n    '),document.getElementById("btn-close-alert").addEventListener("click",(()=>{document.getElementById("custom-alert-modal").classList.remove("active")}))}function showCustomAlert(e,t){createAlertModal(),document.getElementById("alert-title").textContent=e,document.getElementById("alert-message").textContent=t,document.getElementById("custom-alert-modal").classList.add("active")}function showOrderConfirmation(e){createOrderModal();const t=document.getElementById("order-confirm-modal"),n=document.getElementById("order-modal-details"),o=document.getElementById("btn-confirm-order"),a=document.getElementById("btn-cancel-order");return n.innerHTML=`\n        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n            <span>Subtotal Productos:</span> <span>$${e.subtotal}</span>\n        </div>\n        ${e.extras>0?`\n        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n            <span>Adicionales Generales:</span> <span>$${e.extras}</span>\n        </div>`:""}\n        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n            <span>Env√≠o a ${e.barrio}:</span> <span>$${e.envio}</span>\n        </div>\n        ${e.descuento>0?`\n        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #2ecc71;">\n            <span>Descuento (Efectivo):</span> <span>-$${e.descuento}</span>\n        </div>`:""}\n        <div style="border-top: 1px dashed #ccc; margin: 10px 0;"></div>\n        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem; color: #000;">\n            <span>TOTAL FINAL:</span> <span>$${e.total}</span>\n        </div>\n        <div style="margin-top: 10px; font-size: 0.8rem; text-align: center; color: #888;">\n            Tiempo estimado: ${e.tiempo}\n        </div>\n    `,new Promise((e=>{t.classList.add("active");const n=()=>{t.classList.remove("active"),s(),e(!0)},r=()=>{t.classList.remove("active"),s(),e(!1)},s=()=>{o.removeEventListener("click",n),a.removeEventListener("click",r)};o.addEventListener("click",n),a.addEventListener("click",r),t.addEventListener("click",(e=>{e.target===t&&r()}))}))}async function processOrder(){if(!validateForm())return;const e=document.getElementById("customer-name").value.trim(),t=document.getElementById("customer-phone").value.trim(),n=document.getElementById("customer-city").value.trim(),o=document.getElementById("customer-street").value.trim(),a=document.getElementById("customer-number").value.trim(),r=document.getElementById("customer-neighborhood").value.trim(),s=document.getElementById("order-notes")?.value.trim()||"",c=document.querySelector('input[name="payment-method"]:checked')?.value||"Efectivo",l=`${o} ${a}, ${r}, ${n}`;let d=0,i="Consultar";const u=document.getElementById("delivery-cost");if(u&&(u.dataset.cost?d=parseInt(u.dataset.cost)||0:u.textContent.includes("$")&&(d=parseInt(u.textContent.replace(/[^0-9]/g,""))||0)),0===d&&"function"==typeof window.calculateDeliveryFromAddress)try{const e=await window.calculateDeliveryFromAddress(l);e&&e.dentroCobertura&&(d=e.costo,i=e.tiempoEstimado||`${e.duracionCalculada} min`)}catch(e){console.error(e)}if(0===d&&!confirm("No se pudo calcular el costo de env√≠o exacto. Se coordinar√° por WhatsApp. ¬øDeseas continuar?"))return;const m=getCarritoActual(),p=calculateSubtotal(),y=calculateGlobalExtras();let v=p+y+d,f=0;"efectivo"===c&&(f=Math.round(.1*v),v-=f);if(!await showOrderConfirmation({subtotal:p,extras:y,envio:d,barrio:r,descuento:f,total:v,tiempo:i}))return;let g="üìã *NUEVO PEDIDO - COMIDAS AMICI*\n\n";g+=`üë§ *CLIENTE:* ${e}\n`,g+=`üì± *WHATSAPP:* ${t}\n`,g+=`üìç *DIRECCI√ìN DE ENTREGA:*\n${l}\n`;const E=generarUbicacionGoogleMaps();E&&E.texto&&(g+=`${E.texto}\n`),g+=`‚è±Ô∏è Tiempo estimado: ${i}\n`,s&&(g+=`üìù *NOTAS DEL PEDIDO:* ${s}\n`),g+="\nüõí *DETALLE DEL PEDIDO:*\n",g+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n",m.forEach(((e,t)=>{const n=e.name||"Producto",o=e.quantity||1,a=(e.price||0)*o+(e.sauces?e.sauces.reduce(((e,t)=>e+t.price),0):0)+(e.generalExtras?e.generalExtras.reduce(((e,t)=>e+t.price*t.quantity),0):0);if(g+=`${t+1}. *${n}* x${o}\n`,e.empandasFlavors&&e.empandasFlavors.length>0&&(g+=`   ü•ü Gustos: ${e.empandasFlavors.join(", ")}\n`),e.sauces&&e.sauces.length>0){const t=e.sauces.map((e=>e.name)).join(", ");g+=`   üßÇ Salsas: ${t}\n`}e.generalExtras&&e.generalExtras.length>0&&e.generalExtras.forEach((e=>{g+=`   ‚ûï ${e.name} x${e.quantity||1}\n`})),e.notes&&(g+=`   üìù Nota producto: ${e.notes}\n`),g+=`   Subtotal: $${a}\n`,g+="   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"}));const b=document.querySelectorAll('input[type="checkbox"]:not(.cart-item-check)');let $=!1,I="\n‚ûï *ADICIONALES GENERALES:*\n";b.forEach((e=>{if(e.checked){let t=e.id,n=0;e.dataset.price?(n=e.dataset.price,t=e.dataset.name||e.parentElement.innerText.split("$")[0].trim()):e.id.includes("cubiertos")?(t="Cubiertos",n=50):e.id.includes("salsas")?(t="Salsas",n=100):e.id.includes("servilletas")&&(t="Servilletas",n=30),n>0&&($=!0,I+=`   ‚Ä¢ ${t}: $${n}\n`)}})),$&&(g+=I),g+="\nüí∞ *RESUMEN DE PAGO:*\n",g+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n",g+=`M√©todo de pago: ${c.toUpperCase()}\n`,g+=`Subtotal productos: $${p}\n`,y>0&&(g+=`Adicionales generales: $${y}\n`),g+=`Costo de env√≠o: $${d}\n`,f>0&&(g+=`Descuento (10% Efectivo): -$${f}\n`),g+=`*TOTAL A PAGAR: $${v}*\n\n`,g+="¬°Gracias por tu pedido! üçï";const w=`https://wa.me/5493541387884?text=${encodeURIComponent(g)}`;window.open(w,"_blank")}function initForm(){setupMap(),createOrderModal(),createAlertModal();const e=document.getElementById("order-form");e&&(e.addEventListener("submit",(function(e){e.preventDefault(),processOrder()})),e.addEventListener("change",updateOrderSummary),e.addEventListener("input",updateOrderSummary)),updateOrderSummary()}"undefined"!=typeof selectedItems?window.selectedItems=selectedItems:window.selectedItems=[],window.calculateSubtotal=calculateSubtotal,window.calculateGlobalExtras=calculateGlobalExtras,window.validateForm=validateForm,window.processOrder=processOrder,window.getCarritoActual=getCarritoActual,window.updateOrderSummary=updateOrderSummary,window.generarUbicacionGoogleMaps=generarUbicacionGoogleMaps,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initForm):setTimeout(initForm,100);