let foodItems=[],selectedItems=[],currentCategory="todos";async function loadProducts(){try{const e=await fetch("./src/products/products.json"),t=await e.json(),a=["1/2 Docena","Unidad","2 x Fritas (Saladas)"],n=t.productos.filter((e=>"Empanadas"===e.category&&!a.includes(e.titulo))).map((e=>e.titulo));foodItems=t.productos.map(((e,t)=>{let a=[];return"Empanadas"!==e.category||"Unidad"!==e.titulo&&"1/2 Docena"!==e.titulo||(a=n),{id:t+1,name:e.titulo,description:e.descripcion||"",price:e.precio,category:e.category.toLowerCase(),image:e.image||"https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=800&q=80",flavors:a}})),renderFoodItems()}catch(e){console.error(e);document.getElementById("food-grid").innerHTML='<p class="error-msg">Error al cargar el men√∫.</p>'}}function saveToLocalStorage(){try{localStorage.setItem("deliciasExpress_selectedItems",JSON.stringify(selectedItems)),localStorage.setItem("deliciasExpress_currentCategory",currentCategory)}catch(e){console.warn(e)}}function loadFromLocalStorage(){try{const e=localStorage.getItem("deliciasExpress_selectedItems"),t=localStorage.getItem("deliciasExpress_currentCategory");e&&(selectedItems=JSON.parse(e),renderSelectedItems()),t&&(currentCategory=t,document.querySelectorAll(".category-tab").forEach((e=>{e.dataset.category===currentCategory?e.classList.add("active"):e.classList.remove("active")})))}catch(e){console.warn(e)}}function renderFoodItems(){const e=document.getElementById("food-grid");e.innerHTML="";("todos"===currentCategory?foodItems:foodItems.filter((e=>e.category===currentCategory))).forEach((t=>{const a=selectedItems.find((e=>e.id===t.id)),n=document.createElement("div");n.className="food-item "+(a?"in-cart":""),n.dataset.id=t.id;const s=generateExtrasHTML(t);n.innerHTML=`\n            <div class="food-img" style="background-image: url('${t.image}')"></div>\n            <div class="food-content">\n                <h3 class="food-title">${t.name}</h3>\n                <p class="food-description">${t.description}</p>\n                <div class="food-footer">\n                    <div class="food-price">$${t.price}</div>\n                </div>\n                \n                ${s}\n                \n                <div class="card-actions">\n                    <div class="quantity-selector">\n                        <button class="qty-btn minus" onclick="decreaseCardQty(${t.id})">-</button>\n                        <input type="number" id="qty-${t.id}" value="1" min="1" max="99" class="qty-input-card" readonly>\n                        <button class="qty-btn plus" onclick="increaseCardQty(${t.id})">+</button>\n                    </div>\n                    <button class="add-btn" onclick="addToCart(${t.id})">\n                        Agregar\n                    </button>\n                </div>\n            </div>\n        `,e.appendChild(n),setTimeout((()=>{setupExtrasEventListeners(t.id)}),100)}))}function increaseCardQty(e){const t=document.getElementById(`qty-${e}`);let a=parseInt(t.value);a<99&&(t.value=a+1)}function decreaseCardQty(e){const t=document.getElementById(`qty-${e}`);let a=parseInt(t.value);a>1&&(t.value=a-1)}function renderSelectedItems(){const e=document.getElementById("selected-list");if(!e)return;if(0===selectedItems.length)return void(e.innerHTML='\n            <div class="empty-cart" id="empty-cart">\n                <i class="fas fa-shopping-cart"></i>\n                <p>Tu carrito est√° vac√≠o</p>\n                <p>Selecciona productos del cat√°logo</p>\n            </div>\n        ');let t="";selectedItems.forEach(((e,a)=>{const n=(e.sauces?e.sauces.reduce(((e,t)=>e+t.price),0):0)+(e.generalExtras?e.generalExtras.reduce(((e,t)=>e+t.price*t.quantity),0):0);t+=`\n            <div class="selected-item">\n                <div class="item-info">\n                    <span class="item-name">${e.name}</span>\n                    <span class="item-unit-price">($${e.price} c/u)</span>\n                </div>\n                \n                ${e.empandasFlavors&&e.empandasFlavors.length>0?`\n                    <div class="cart-flavors">\n                        <div class="cart-extras-title">Gustos:</div>\n                        <ul class="flavors-list">\n                            ${e.empandasFlavors.map((e=>`<li>‚Ä¢ ${e}</li>`)).join("")}\n                        </ul>\n                    </div>\n                `:""}\n\n                ${e.notes?`<div class="cart-product-notes">üìù ${e.notes}</div>`:""}\n                \n                ${e.sauces&&e.sauces.length>0||e.generalExtras&&e.generalExtras.length>0?`\n                    <div class="cart-extras">\n                        <div class="cart-extras-title">Adicionales:</div>\n                        ${e.sauces&&e.sauces.length>0?e.sauces.map((e=>`\n                            <div class="cart-extra-item">\n                                <span class="cart-extra-name">\n                                    <i class="fas fa-wine-bottle"></i> ${e.name}\n                                </span>\n                                <span class="cart-extra-price">+$${e.price}</span>\n                            </div>\n                        `)).join(""):""}\n                        \n                        ${e.generalExtras&&e.generalExtras.length>0?e.generalExtras.map((e=>`\n                            <div class="cart-extra-item">\n                                <span class="cart-extra-name">\n                                    <i class="fas fa-plus-circle"></i> ${e.name}\n                                    <span class="cart-extra-quantity">x${e.quantity}</span>\n                                </span>\n                                <span class="cart-extra-price">+$${e.price*e.quantity}</span>\n                            </div>\n                        `)).join(""):""}\n                    </div>\n                `:""}\n                \n                <div class="item-actions">\n                    <div class="cart-qty-selector">\n                        <button class="cart-qty-btn" onclick="updateCartItemQuantity(${a}, -1)">-</button>\n                        <input type="text" value="${e.quantity}" class="cart-qty-input" readonly>\n                        <button class="cart-qty-btn" onclick="updateCartItemQuantity(${a}, 1)">+</button>\n                    </div>\n                    <div class="item-price">$${e.price*e.quantity+n}</div>\n                    <button class="remove-item-btn" onclick="removeSelectedItem(${a})" aria-label="Eliminar">\n                        <i class="fas fa-trash-alt"></i>\n                    </button>\n                </div>\n            </div>\n        `})),t+='\n        <div class="cart-footer-actions">\n            <button onclick="openClearCartModal()" class="clear-cart-btn">\n                <i class="fas fa-trash"></i> Vaciar Carrito\n            </button>\n        </div>\n    ',e.innerHTML=t}function updateCartItemQuantity(e,t){const a=selectedItems[e],n=a.quantity+t;n<1?removeSelectedItem(e):n>99||(a.quantity=n,renderSelectedItems(),updateOrderSummary(),saveToLocalStorage())}function removeSelectedItem(e){const t=selectedItems[e];selectedItems.splice(e,1),showNotification(`${t.name} eliminado`,"success"),renderSelectedItems(),renderFoodItems(),updateOrderSummary(),saveToLocalStorage()}function openClearCartModal(){document.getElementById("confirmation-modal").classList.add("active")}function closeClearCartModal(){document.getElementById("confirmation-modal").classList.remove("active")}function confirmClearCart(){selectedItems=[],renderSelectedItems(),renderFoodItems(),updateOrderSummary(),saveToLocalStorage(),closeClearCartModal(),showNotification("Carrito vaciado correctamente","success"),document.querySelectorAll(".extra-checkbox").forEach((e=>{e.checked=!1}))}function updateOrderSummary(){const e=selectedItems.reduce(((e,t)=>{const a=t.sauces?t.sauces.reduce(((e,t)=>e+t.price),0):0,n=t.generalExtras?t.generalExtras.reduce(((e,t)=>e+t.price*t.quantity),0):0;return e+(t.price*t.quantity+a+n)}),0),t=Array.from(document.querySelectorAll(".extra-checkbox:checked")).reduce(((e,t)=>e+parseInt(t.dataset.price||0)),0),a=e+t,n=document.querySelector('input[name="payment-method"]:checked')?.value,s=document.getElementById("discount-row"),c=document.getElementById("discount-amount");let o=a;if("efectivo"===n){const e=Math.round(.1*o);o-=e,s&&c&&(s.style.display="flex",c.textContent=`-$${e}`)}else s&&(s.style.display="none");const r=document.getElementById("subtotal"),d=document.getElementById("total-cost");r&&(r.textContent=`$${a}`),d&&(d.textContent=`$${o}`);const i=document.getElementById("floating-cart-btn"),l=document.getElementById("float-count"),u=document.getElementById("float-total");if(selectedItems.length>0){const e=selectedItems.reduce(((e,t)=>e+t.quantity),0);l&&(l.textContent=e),u&&(u.textContent=`$${o}`),i&&i.classList.add("visible")}else i&&i.classList.remove("visible")}function addToCart(e){const t=foodItems.find((t=>t.id===e));if(!t)return;const a=document.getElementById(`qty-${e}`),n=parseInt(a.value)||1,s="empanadas"===t.category,c=s&&t.name.toLowerCase().includes("unidad"),o=s&&t.name.toLowerCase().includes("1/2");let r=[];if(s)if(c){const t=window.getEmpanadaSelection(e,!0,!1);if(!t||0===t.length){showNotification("‚ö†Ô∏è Debes seleccionar 1 gusto para la empanada","error");const t=document.querySelector(`.extras-toggle-btn[data-product-id="${e}"]`);return void(t&&!t.classList.contains("expanded")&&t.click())}r=t}else if(o){const t=window.getEmpanadaSelection(e,!1,!0);if(6!==t.totalCount){showNotification(`‚ö†Ô∏è Debes seleccionar exactamente 6 empanadas (llevas ${t.totalCount})`,"error");const a=document.querySelector(`.extras-toggle-btn[data-product-id="${e}"]`);return void(a&&!a.classList.contains("expanded")&&a.click())}r=t.flavorsList}const d=document.querySelectorAll(`.sauce-checkbox[data-product-id="${e}"]:checked`),i=Array.from(d).map((e=>({name:e.dataset.name,price:parseInt(e.dataset.price)}))),l=document.querySelectorAll(`.general-extra-checkbox[data-product-id="${e}"]:checked`),u=Array.from(l).map((e=>{const t=document.getElementById(`extra-qty-${e.dataset.extraId}`),a=t&&parseInt(t.value)||1;return{id:e.dataset.extraId,name:e.dataset.name,price:parseInt(e.dataset.price),quantity:a}})),m=document.getElementById(`product-notes-${e}`),p=m?m.value.trim():"",y=selectedItems.findIndex((t=>t.id===e&&JSON.stringify(t.sauces)===JSON.stringify(i)&&JSON.stringify(t.generalExtras)===JSON.stringify(u)&&JSON.stringify(t.empandasFlavors)===JSON.stringify(r)&&t.notes===p));if(y>=0)selectedItems[y].quantity+=n,showNotification(`Se agregaron ${n} m√°s de ${t.name}`,"success");else{const e={...t,quantity:n,sauces:i,generalExtras:u,empandasFlavors:r,notes:p};selectedItems.push(e),showNotification(`${t.name} agregado al carrito`,"success")}resetProductControls(e),a.value=1,renderFoodItems(),renderSelectedItems(),updateOrderSummary(),saveToLocalStorage()}function resetProductControls(e){document.querySelectorAll(`.sauce-checkbox[data-product-id="${e}"]`).forEach((e=>{e.checked=!1,e.parentElement.classList.remove("selected")})),document.querySelectorAll(`.general-extra-checkbox[data-product-id="${e}"]`).forEach((e=>{e.checked=!1,e.parentElement.classList.remove("selected");const t=e.dataset.extraId,a=document.getElementById(`extra-qty-${t}`);a&&(a.value=1)}));const t=document.getElementById(`product-notes-${e}`);t&&(t.value=""),"function"==typeof window.resetEmpanadaSelection&&window.resetEmpanadaSelection(e);const a=document.querySelector(`.extras-toggle-btn[data-product-id="${e}"]`),n=document.getElementById(`extras-container-${e}`);a&&a.classList.remove("expanded"),n&&n.classList.remove("expanded")}function setupEventListeners(){document.querySelectorAll(".category-tab").forEach((e=>{e.addEventListener("click",(function(){document.querySelectorAll(".category-tab").forEach((e=>e.classList.remove("active"))),this.classList.add("active"),currentCategory=this.dataset.category,renderFoodItems(),saveToLocalStorage()}))})),document.querySelectorAll(".extra-checkbox").forEach((e=>{e.addEventListener("change",(function(){updateOrderSummary(),saveToLocalStorage(),this.checked&&showNotification(`${this.dataset.name} a√±adido`,"success")}))})),document.querySelectorAll('input[name="payment-method"]').forEach((e=>{e.addEventListener("change",updateOrderSummary)}));const e=document.getElementById("order-form");e&&e.addEventListener("submit",(function(e){e.preventDefault(),"function"==typeof processOrder&&processOrder()}));const t=document.getElementById("customer-phone");t&&t.addEventListener("input",(function(){this.value=this.value.replace(/[^0-9]/g,"").slice(0,15)}));const a=document.getElementById("notification");a&&a.addEventListener("click",(function(){this.classList.remove("show")}));const n=document.getElementById("modal-cancel");n&&n.addEventListener("click",closeClearCartModal);const s=document.getElementById("modal-confirm");s&&s.addEventListener("click",confirmClearCart);const c=document.getElementById("confirmation-modal");c&&c.addEventListener("click",(function(e){e.target===this&&closeClearCartModal()}));const o=document.getElementById("floating-cart-btn");o&&o.addEventListener("click",(function(){const e=document.getElementById("cart-section");e&&e.scrollIntoView({behavior:"smooth"})}))}function showNotification(e,t="success"){const a=document.getElementById("notification"),n=document.getElementById("notification-text");if(!a||!n)return;n.textContent=e,a.className="notification",a.classList.add("error"===t?"error":"warning"===t?"warning":"show"),a.classList.add("show");setTimeout((()=>{a.classList.remove("show")}),"error"===t||"warning"===t?5e3:3e3)}document.addEventListener("DOMContentLoaded",(function(){loadProducts(),loadFromLocalStorage(),setupEventListeners(),updateOrderSummary()})),document.addEventListener("touchstart",(function(){}),{passive:!0}),document.addEventListener("touchmove",(function(e){"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName||e.preventDefault()}),{passive:!1});